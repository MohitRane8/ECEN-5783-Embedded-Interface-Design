<!doctype html>
<html>
	<head>
		<title>Temperature & Humidity Monitoring System</title>
		<meta charset="utf-8" />
		<style type="text/css">
			body {
				text-align: center;
				min-width: 500px;
			}
		</style>
		<script src="http://code.jquery.com/jquery.min.js"></script>
		<script>
			
			var start_time;
			var end_time;
			var difference;
			var temp_flag = 0;	//Celsius
			
			// log function
			log = function(data){
				$("div#terminal").prepend("</br>" +data);
				console.log(data);
			};
	
			$(document).ready(function () {
				$("div#message_details").hide()

				var ws;

				$("#open").click(function(evt) {
					evt.preventDefault();
			
					var host = $("#host").val();
					var port = $("#port").val();
					var uri = $("#uri").val();
				
					
					// create websocket instance
					ws = new WebSocket("ws://" + host + ":" + port + uri);
					
					// Handle incoming websocket message callback
					ws.onmessage = function(evt) {
						console.log('evt data: ' + evt.data);
						var recv_msg = JSON.parse(evt.data);
						
						//Calculate End Time
						var end_time = performance.now();
						
						//Calculate Length of received data
						var length_of_data = Object.keys(recv_msg).length;
						
						console.log(length_of_data);		
						
						if (length_of_data == 2)
						{
							
							//if(temp_flag == 0)
							//{
							//}
							$("#Output_Temperature").val(recv_msg.temp.toFixed(2));
							$("#Output_Humidity").val(recv_msg.hum.toFixed(2));
						}
						else if (length_of_data == 10)
						{
							
							var i;
							for(i=0;i<length_of_data;i++)
							{
								var newRow = tornado_table.insertRow(tornado_table.length);
							
								for(var j=0; j <1  ; j++)
								{
									var cell = newRow.insertCell(j);
									cell.innerHTML = recv_msg[i].toFixed(2);							
								}
							}
							
							//Tabulate Start,End and Difference time for tornado query
							var newRow = tornado_timestamp.insertRow(tornado_timestamp.length);
							var cell = newRow.insertCell(0);
							cell.innerHTML = start_time.toFixed(2);
							cell = newRow.insertCell(1);
							cell.innerHTML = end_time.toFixed(2);
							cell = newRow.insertCell(2);
							difference = end_time - start_time;
							cell.innerHTML = difference.toFixed(2) ;

						}
					};
			
					// Close Websocket callback
					ws.onclose = function(evt) {
						log("***Connection Closed***");
						alert("Connection close");
						$("#host").css("background", "#ff0000"); 
						$("#port").css("background", "#ff0000"); 
						$("#uri").css("background",  "#ff0000");
						$("div#message_details").empty();
					};
			
					// Open Websocket callback
					ws.onopen = function(evt) { 
						$("#host").css("background", "#00ff00"); 
						$("#port").css("background", "#00ff00"); 
						$("#uri").css("background", "#00ff00");
						$("div#message_details").show();
						
						log("***Connection Opened***");
					};
				});

				// Send websocket message function
				$("#send").click(function(evt) {
					log("Sending Message: "+$("#message").val());
					ws.send($("#message").val());
				});
			
				// Get latest temperature
				$("#Get_Latest_Values").click(function(evt) {
					ws.send("Temperature");
				}); 
			
				// Get ten latest values
				$("#Get_Ten_Latest_Values").click(function(evt) {
					start_time = performance.now();
					ws.send("Get_Ten_Latest_Values");
				});

				// -----------------NodeJS and MySQL Script------------------
				const wsjs = new WebSocket('ws://10.0.0.180:9898/');

				// timing parameters
				var startTime;
				var stopTime;
				var elapsedTime;

				wsjs.onopen = function() {
					console.log('WebSocket Client Connected');
					wsjs.send('Hi this is web client.');
				};

				wsjs.onmessage = function(e) {
					console.log("Received: '" + e.data + "'");

					// split string containing array of values separated by comma
					var arr = e.data.split(",");
					console.log(arr);
					// console.log(arr.length);

					// get timing parameters
					if (arr.length == 10) {
						// get stop time of transaction
						stopTime = performance.now();
						console.log('stop time = ' + stopTime);
						
						// total transaction time
						elapsedTime = stopTime - startTime;
						console.log('elapsed time = ' + elapsedTime);
						
						var i;
						for(i=0;i<arr.length;i++)
						{
							var newRow = nodejs_table.insertRow(nodejs_table.length);
							for(var j=0; j <1  ; j++)
							{
								var cell = newRow.insertCell(j);
								cell.innerHTML = arr[i];							
							}
						}
						
						//Tabulate Start,End and Difference time for nodejs query
						var newRow = nodejs_timestamp.insertRow(nodejs_timestamp.length);
						var cell = newRow.insertCell(0);
						cell.innerHTML = startTime.toFixed(2);
						cell = newRow.insertCell(1);
						cell.innerHTML = stopTime.toFixed(2);
						cell = newRow.insertCell(2);
						cell.innerHTML = elapsedTime.toFixed(2);
					}
					
					else if (arr.length == 2) {
						console.log('Temperature: ' + arr[0]);
						$("#Output_NodeJS_Temperature").val(arr[0]);
						console.log('Humidity: ' + arr[1]);
						$("#Output_NodeJS_Humidity").val(arr[1]);
					}
				};

				// Request data from server on button click
				$("#Get_Latest_Values_for_NodeJS").click(function(evt) {
					console.log('Get Latest Value Button clicked');

					// Inform server that button is clicked
					wsjs.send('1');
				});

				// Request data from server on button click
				$("#Get_Ten_Latest_Values_for_NodeJS").click(function(evt) {
					console.log('Get Ten Value Button clicked');

					// get start time of transaction
					startTime = performance.now();
					console.log('start time = ' + startTime);

					// Inform server that button is clicked
					wsjs.send('2');
					
					start_time = performance.now();
					ws.send("Get_Ten_Latest_Values");
				});
			});	
		</script>

</head>
	
	<body>
		<h1>Temperature and Humidity Monitoring System</h1>
		<div id="connection_details">
			<label for="host">host:</label>
			<input type="text" id="host" value="10.0.0.180" style="background:#ff0000;"/><br />
			<label for="port">port:</label>
			<input type="text" id="port" value="8888" style="background:#ff0000;"/><br />
			<label for="uri">uri:</label>
			<input type="text" id="uri" value="/ws" style="background:#ff0000;"/><br />
			<input type="submit" id="open" value="open" />
		</div>
		
	<div id="message_details">
		</br></br>
		<label for="message">message:</label>
		<input type="text" id="message" value="Hello World!"/><br />
		<input type="submit" id="send" value="send" />
	</div>

	<!--Label for Tornado Temperature-->
	<label for="Temperature" id="Label_Temperature" style="float: left">Tornado Temperature: </label>
	<!--Label for NodeJS Temperature-->
	<label for="NodeJS_Temperature" id="Label_NodeJS_Temperature" style="float: right">NodeJS Temperature: </label>
	<!--Output for Tornado Temperature-->
	<output type="text" id="Output_Temperature" style="float: left"></output></br>
	<!--Output for NodeJS Temperature-->
	<output type="text" id="Output_NodeJS_Temperature" style="float: right"></output>

	<!--Label for Tornado Humidity -->
	<label for="Humidity" id="Label_Humidity" style="float: left">Tornado Humidity: </label>
	<!--Label for NodeJS Humidity -->
	<label for="NodeJS_Humidity" id="Label_NodeJS_Humidity" style="float: right">NodeJS Humidity: </label>
	<!--Output for Tornado Humidity-->
	<output type="text" id="Output_Humidity" style="float: left"></output></br>
	<!--Output for NodeJS Humidity-->
	<output type="text" id="Output_NodeJS_Humidity" style="float: right"></output></br>

	<!--Button For  latest values -->
	<input type="submit" id="Get_Latest_Values" value="Get Latest Values" style="float: left" /> </input>
	<input type="submit" id="Get_Latest_Values_for_NodeJS" value="Get Latest Values" style="float: right" /> </input>
	</br>
	</br>
	<!--Button for last ten latest Values  -->
	<input type="submit" id="Get_Ten_Latest_Values" value="Get Ten Latest Values" style="float: left" /> </input>
	<input type="submit" id="Get_Ten_Latest_Values_for_NodeJS" value="Get Ten Latest Values" style="float: right" /> </input>
	
	<!--Button for Celsius/Fahrenheit change -->
	<input type="submit" id="Celsius" value="Celsius/Fahrenheit"/> </input>
	<!--Output for Cel/Fah -->
	<output type="text" id="Output_C_F" ></output></br>

</br></br>


	

	



<div>
	<table id="tornado_table" border="1" style="float:left">
	<caption>Tornado</caption>
	<tr>
		<th>Humidity</th>
	</tr>
	</table>
	
	<table id="tornado_timestamp" border="1" style="float:left">
	<caption>Time Analysis</caption>
	<tr>
		<th>Start</th>
		<th>End</th>
		<th>Difference</th>
	</tr>
	</table>

	
	<table id="nodejs_timestamp" border="1" style="float:right">
	<caption>Time Analysis</caption>
	<tr>
		<th>Start</th>
		<th>End</th>
		<th>Difference</th>
	</tr>
	</table>
	
	<table id="nodejs_table" border="1" align="right" style="float: right">
	<caption>NodeJS</caption>
	<tr>
		<th>Humidity</th>
	</tr>
	</table>
	

</div>
	
	<script>
	tornado_table = document.getElementById("tornado_table");
	</script>
	
	
	<script>
	nodejs_table = document.getElementById("nodejs_table");
	</script>
	
		
	</script>
	
		<div id="terminal">			
		</div>
		</body>
</html>
