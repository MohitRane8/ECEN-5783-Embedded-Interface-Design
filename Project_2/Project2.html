<!doctype html>
<html>
	<head>
		<title>Temperature & Humidity Monitoring System</title>
		<meta charset="utf-8" />
		<style type="text/css">
			body {
				text-align: center;
				min-width: 500px;
			}
		</style>
		<script src="http://code.jquery.com/jquery.min.js"></script>
		<script>
			
		var start_time;
		var end_time;
		var difference;
		
			
		// log function
		log = function(data){
        $("div#terminal").prepend("</br>" +data);
        console.log(data);
		};
 
		$(document).ready(function () {
        $("div#message_details").hide()
 
        var ws;
 
        $("#open").click(function(evt) {
			evt.preventDefault();
	
			var host = $("#host").val();
			var port = $("#port").val();
			var uri = $("#uri").val();
		
			
			// create websocket instance
			ws = new WebSocket("ws://" + host + ":" + port + uri);
			
			// Handle incoming websocket message callback
			ws.onmessage = function(evt) {
				console.log('evt data: ' + evt.data);
				var recv_msg = JSON.parse(evt.data);
				
				//Calculate End Time
				var d = new Date();
				var end_time = d.getTime();
				
				//Calculate Length of received data
				var length_of_data = Object.keys(recv_msg).length;
				
				console.log(length_of_data);		
				
				if (length_of_data == 2)
				{
					$("#Output_Temperature").val(recv_msg.temp.toFixed(2));
					$("#Output_Humidity").val(recv_msg.hum.toFixed(2));
				}
				else if (length_of_data == 10)
				{
					var i;
					for(i=0;i<length_of_data;i++)
					{
						var d = new Date();
						var n = d.getTime();
						var newRow = tornado_table.insertRow(tornado_table.length);
						for(var j=0; j <1  ; j++)
						{
							var cell = newRow.insertCell(j);
							cell.innerHTML = recv_msg[i].toFixed(2);							
						}
						for(var j=1; j <2  ; j++)
						{
							var cell = newRow.insertCell(j);
							cell.innerHTML = n;							
						}
						//$("#Get_Ten_Latest_Values").val(recv_msg[i].toFixed(2));
						//console.log(recv_msg[i]);
						console.log("Added Row")
					}
					
					//Tabulate Start,End and Difference time for tornado query
					var newRow = tornado_timestamp.insertRow(tornado_timestamp.length);
					var cell = newRow.insertCell(0);
					cell.innerHTML = start_time;
					cell = newRow.insertCell(1);
					cell.innerHTML = end_time;
					cell = newRow.insertCell(2);
					cell.innerHTML = end_time - start_time ;
					
					
					for(i=0;i<length_of_data;i++)
					{
						var d = new Date();
						var n = d.getTime();
						var newRow = nodejs_table.insertRow(nodejs_table.length);
						for(var j=0; j <1  ; j++)
						{
							var cell = newRow.insertCell(j);
							cell.innerHTML = recv_msg[i].toFixed(2);							
						}
						for(var j=1; j <2  ; j++)
						{
							var cell = newRow.insertCell(j);
							cell.innerHTML = n;							
						}
						//$("#Get_Ten_Latest_Values").val(recv_msg[i].toFixed(2));
						//console.log(recv_msg[i]);
						console.log("Added Row")
					}
				}
			};
	
			// Close Websocket callback
			ws.onclose = function(evt) {
				log("***Connection Closed***");
				alert("Connection close");
				$("#host").css("background", "#ff0000"); 
				$("#port").css("background", "#ff0000"); 
				$("#uri").css("background",  "#ff0000");
				$("div#message_details").empty();
			};
	
			// Open Websocket callback
			ws.onopen = function(evt) { 
				$("#host").css("background", "#00ff00"); 
				$("#port").css("background", "#00ff00"); 
				$("#uri").css("background", "#00ff00");
				$("div#message_details").show();
				
				log("***Connection Opened***");
			};
		});
 
        // Send websocket message function
        $("#send").click(function(evt) {
			log("Sending Message: "+$("#message").val());
			ws.send($("#message").val());
      	});
      
		// Get latest temperature
		$("#Get_Latest_Values").click(function(evt) {
			//log("Sending temperature: "+$("#Temperature").val());
			//ws.send($("#Temperature").val());
			ws.send("Temperature");
		}); 
      
		// Get ten latest values
		$("#Get_Ten_Latest_Values").click(function(evt) {
			var d = new Date();
			start_time = d.getTime();
			ws.send("Get_Ten_Latest_Values");
		});
    });	
</script>

</head>
	
	<body>
		<h1>Temperature and Humidity Monitoring System</h1>
		<div id="connection_details">
			<label for="host">host:</label>
			<input type="text" id="host" value="localhost" style="background:#ff0000;"/><br />
			<label for="port">port:</label>
			<input type="text" id="port" value="8888" style="background:#ff0000;"/><br />
			<label for="uri">uri:</label>
			<input type="text" id="uri" value="/ws" style="background:#ff0000;"/><br />
			<input type="submit" id="open" value="open" />
		</div>
		
	<div id="message_details">
		</br></br>
		<label for="message">message:</label>
		<input type="text" id="message" value="Hello World!"/><br />
		<input type="submit" id="send" value="send" />
	</div>

	<label for="Temperature" id="Label_Temperature">Temperature: </label>
	<output type="text" id="Output_Temperature"></output></br>
	<label for="Humidity" id="Label_Humidity">Humidity: </label>
	<output type="text" id="Output_Humidity"></output></br>
	<input type="submit" id="Get_Latest_Values" value="Get_Latest_Values" /> </input>
	</br></br>
	<label for="Get_Ten_Latest_Values" id="Label_Get_Ten_Latest_Values">Get_Ten_Latest_Values: </label>
	<output type="text" id="Output_Get_Ten_Latest_Values"></output></br>
	<input type="submit" id="Get_Ten_Latest_Values" value="Get_Ten_Latest_Values" /> </input>
	
<div>
	<table id="tornado_table" border="1" style="float:left">
	<caption>Tornado Table</caption>
	<tr>
		<th>Humidity</th>
		<th>Current_Timestamp</th>
	</tr>
	</table>
	
	<table id="tornado_timestamp" border="1" style="float:left">
	<caption>Tornado Time Analysis</caption>
	<tr>
		<th>Start</th>
		<th>End</th>
		<th>Difference</th>
	</tr>
	</table>

	
	<table id="nodejs_timestamp" border="1" style="float:right">
	<caption>NodeJS Time Analysis</caption>
	<tr>
		<th>Start</th>
		<th>End</th>
		<th>Difference</th>
	</tr>
	</table>
	
	<table id="nodejs_table" border="1" align="right" style="float: right">
	<caption>NodeJS Table</caption>
	<tr>
		<th>Humidity</th>
		<th>Current_Timestamp</th>
	</tr>
	</table>
	

</div>
	
	<script>
	tornado_table = document.getElementById("tornado_table");
	</script>
	
	
	<script>
	nodejs_table = document.getElementById("nodejs_table");
	</script>
	
		
	</script>
	
		<div id="terminal">			
		</div>
		</body>
</html>
