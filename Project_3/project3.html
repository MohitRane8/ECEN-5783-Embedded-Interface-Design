<!doctype html>
<html>
	<head>
		<title>AWS Temperature and Humidity Monitoring System</title>
		<meta charset="utf-8" />
		<style type="text/css">
		  body {
			text-align: center;
			min-width: 500px;
		  }
		</style>
	</head>
	
	<script src="https://sdk.amazonaws.com/js/aws-sdk-2.410.0.min.js"></script>
	<script src="http://code.jquery.com/jquery.min.js"></script>
	
	<script>

	$(document).ready(function () {	
		console.log("enter");
		
		// Initialize the Amazon Cognito credentials provider
		AWS.config.region = 'us-east-1'; // Region
		AWS.config.credentials = new AWS.CognitoIdentityCredentials({
			IdentityPoolId: 'us-east-1:be5744aa-53a3-47ab-91a6-45a7b1759e8f',
		});
		
		var mysqs = new AWS.SQS();
		
		var queueUrl = 'https://sqs.us-east-1.amazonaws.com/222513434401/my_queue_project_3';
		
		// for single value
		var singleRecvParams = {
			QueueUrl: queueUrl,
			AttributeNames: [
				'All'
			],
			MaxNumberOfMessages: '1',
			VisibilityTimeout: '0',
			WaitTimeSeconds: '1'
		};
		
		// for all values
		var allRecvParams = {
			QueueUrl: queueUrl,
			AttributeNames: [
				'All'
			],
			MaxNumberOfMessages: '1',
			VisibilityTimeout: '1',
			WaitTimeSeconds: '1'
		};		
		
		// to delete queue
		var delQueParams = {
			QueueUrl: queueUrl
		};
		
		// for message count
		var attrParams = {
			QueueUrl: queueUrl,
			AttributeNames: [
				'ApproximateNumberOfMessages'
			]
		};
		
		// temperature unit change flag
		// 0 - C, 1 = F
		// default - C
		var tempUnitFlag = 0;
		
		/****	1	****/
		// get single value from SQS on button click and delete that entry from SQS
		$('#getValueBtn').click(function(){			
			// receive message
			mysqs.receiveMessage(singleRecvParams, function(err, data) {
				if (err) console.log(err, err.stack); // an error occurred
				else {				
					// log full data
					//console.log(data);
					// log JSON body having timestamp, temperature and humidity values
					//console.log(data.Messages[0].Body);
					// parse JSON object
					var reqParams = JSON.parse(data.Messages[0].Body);
					
					var timeValue = reqParams.timestamp;
					var tempValue = reqParams.temperature;
					var humValue = reqParams.humidity;
					
					// set temperature values according to required units
					if(tempUnitFlag == 1) {
						tempValue = tempValue*1.8+32;
					}
					
					// TODO: DISPLAY IN HTML
					// log required parameters
					console.log(timeValue);
					console.log(tempValue);
					console.log(humValue);
					$("#Output_Temperature").val(tempValue);
					$("#Output_Humidity").val(humValue);
					// delete entry from SQS
					/*
					var delParams = {
						QueueUrl: queueUrl, // required
						ReceiptHandle: String(data.Messages[0].ReceiptHandle)
					};
					mysqs.deleteMessage(delParams, function(err, data) {
						if (err) console.log(err, err.stack); // an error occurred
						else     console.log(data);
					});
					*/
				}
			});
			
			// get number of messages in SQS
			mysqs.getQueueAttributes(attrParams, function(err, data) {
				if (err) console.log(err, err.stack); // an error occurred
				else {
					//console.log(data);
					console.log(data.Attributes.ApproximateNumberOfMessages);
				}
			});
		})
		
		
		/****	2	****/
		// get all values from SQS on button click, fill table with 20 values and delete all entries from SQS
		$('#allValuesBtn').click(function(){
		
			// get number of messages in SQS
			mysqs.getQueueAttributes(attrParams, function(err, data) {
				if (err) console.log(err, err.stack); // an error occurred
				else {
					console.log(data.Attributes.ApproximateNumberOfMessages);
					
					var i;
					var timeArray = [];
					var tempArray = [];
					var humArray = [];
					for (i = 0; i < data.Attributes.ApproximateNumberOfMessages; i++) {	
						// receive message
						mysqs.receiveMessage(allRecvParams, function(err, data) {
							if (err) console.log(err, err.stack); // an error occurred
							else {				
								// log full data
								//console.log(data);
								// log JSON body having timestamp, temperature and humidity values
								//console.log(data.Messages[0].Body);
								// parse JSON object
								var reqParams = JSON.parse(data.Messages[0].Body);
								
								// store parameters in array
								timeArray[i%20] = reqParams.timestamp;
								tempArray[i%20] = reqParams.temperature;
								humArray[i%20] = reqParams.humidity;
								
								// set temperature values according to required units
								if(tempUnitFlag == 1) {
									tempArray[i%20] = tempArray[i%20]*1.8+32;
								}
								
								console.log("timestamp [%d] = %s", i, timeArray[i%20]);
								console.log("temperature [%d] = %f", i, tempArray[i%20]);
								console.log("humidity [%d] = %f", i, humArray[i%20]);
								
								// delete entry from SQS
								/*
								var delParams = {
									QueueUrl: queueUrl, // required
									ReceiptHandle: String(data.Messages[0].ReceiptHandle)
								};
								mysqs.deleteMessage(delParams, function(err, data) {
									if (err) console.log(err, err.stack); // an error occurred
									else     console.log(data);
								});
								*/
							}
						});
					}
					
				}
			});
			
			// get number of messages in SQS
			mysqs.getQueueAttributes(attrParams, function(err, data) {
				if (err) console.log(err, err.stack); // an error occurred
				else {
					//console.log(data);
					console.log(data.Attributes.ApproximateNumberOfMessages);
				}
			});
		})
		
		
		/****	3	****/
		// get number of messages in SQS
		$('#msgCountBtn').click(function(){	
			mysqs.getQueueAttributes(attrParams, function(err, data) {
				if (err) console.log(err, err.stack); // an error occurred
				else {
					//console.log(data);
					console.log(data.Attributes.ApproximateNumberOfMessages);
				}
			});
		})
		
		/****	4	****/
		// convert units of temperature
		$('#tempUnitBtn').click(function(){	
			if (tempUnitFlag == 0) {
				tempUnitFlag = 1;
			}
			else {
				tempUnitFlag = 0;
			}
		})
	});
	
    </script>
 
  <body>
  
	<p id="demo"></p>

    <button type="button" id="getValueBtn">Get Value</button> 
	<button type="button" id="allValuesBtn">Get All Values</button> 
	<button type="button" id="msgCountBtn">Get Message Count</button> 
	<button type="button" id="tempUnitBtn">C/F</button>	
	
	<!--Label for Temperature-->
	<label for="Temperature" id="Label_Temperature">Temperature: </label></br>
	<output type="text" id="Output_Temperature" ></output></br>

	<!--Label for Humidity -->
	<label for="Humidity" id="Label_Humidity">Humidity: </label>
	<!--Output for Humidity-->
	<output type="text" id="Output_Humidity"></output></br>
	
	<!--Output for Cel/Fah -->
	<output type="text" id="Output_C_F" ></output></br>
	

  </body>
</html>
<!--style="float: left"-->
